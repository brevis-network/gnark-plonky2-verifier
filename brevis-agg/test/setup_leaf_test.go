package test

import (
	"github.com/brevis-network/zk-utils/common/utils"
	"github.com/celer-network/goutils/log"
	"github.com/consensys/gnark-crypto/ecc"
	"github.com/consensys/gnark/backend/groth16"
	"github.com/consensys/gnark/logger"
	regroth16 "github.com/consensys/gnark/std/recursion/groth16"
	"github.com/consensys/gnark/test"
	"github.com/rs/zerolog"
	"os"
	"testing"
)

func TestSetupMiddleHashNode(t *testing.T) {
	logger.Set(zerolog.New(zerolog.ConsoleWriter{Out: os.Stdout, TimeFormat: "15:04:05"}).With().Timestamp().Logger())
	assert := test.NewAssert(t)

	data := []uint64{13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 13898775, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837, 2518340233, 3824780546060912772, 17238284207657672158, 271207744467742, 0, 0, 0, 0, 0, 5996636112837}
	ccs, subProofPk1, subProof1, subVk1, subWitness1, mimcHash, glHash := GetLeafProof(assert, data)
	err := groth16.Verify(subProof1, subVk1, subWitness1, regroth16.GetNativeVerifierOptions(ecc.BN254.ScalarField(), ecc.BN254.ScalarField()))
	assert.NoError(err)
	log.Infof("get leaf done")
	log.Infof("mimcHash: %v", mimcHash)
	log.Infof("glHash: %v", glHash)

	err = utils.WriteProofIntoLocalFile(subProof1, "./setup_data/leaf_hash.proof")
	assert.NoError(err)
	err = utils.WriteVerifyingKey(subVk1, "./setup_data/leaf_hash.vk")
	assert.NoError(err)
	err = utils.WriteWitness("./setup_data/leaf_hash.witness", subWitness1)
	assert.NoError(err)

	utils.WriteCcs(ccs, "./setup_data/leaf_hash.ccs")
	utils.WriteProvingKey(subProofPk1, "./setup_data/leaf_hash.pk")
}
